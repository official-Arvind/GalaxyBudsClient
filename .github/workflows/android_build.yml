name: Build Android APK
on:
  push:
    branches:
      - master

env:
  DOTNET_VERSION: '8.0'
  JAVA_VERSION: '17'

jobs:
  build:
    runs-on: windows-2022
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}.x

      - name: Install MAUI Workload
        run: dotnet workload install maui-android --skip-sign-check

      - name: Clean Solution
        run: dotnet clean --nologo -v minimal || true

      - name: Restore Dependencies (net8.0-android)
        run: dotnet restore GalaxyBudsClient.Android/GalaxyBudsClient.Android.csproj -p:IsAndroid=true

      - name: Build Android APK
        run: |
          dotnet publish GalaxyBudsClient.Android/GalaxyBudsClient.Android.csproj `
            -f net8.0-android34.0 `
            -c Release `
            -p:IsAndroid=true `
            -p:AndroidPackageFormats=apk `
            --no-restore

      - name: Upload APK Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyBudsClient-APK
          path: GalaxyBudsClient.Android/bin/Release/net8.0-android34.0/*-Signed.apk
          if-no-files-found: ignore

      - name: Upload App Bundle Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyBudsClient-AAB
          path: GalaxyBudsClient.Android/bin/Release/net8.0-android34.0/*-Signed.aab
          if-no-files-found: ignore
          
