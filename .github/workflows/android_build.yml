name: Build Android APK
on:
  push:
    branches:
      - master

env:
  DOTNET_VERSION: '8.0'
  JAVA_VERSION: '17'

jobs:
  build:
    runs-on: windows-2022
    env:
      ANDROID_SDK_ROOT: C:\\Android\\android-sdk
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platform-tools
            build-tools;34.0.0
            platforms;android-34
          accept-android-sdk-licenses: true
          cmdline-tools-version: '12266719'

      - name: Accept Android SDK Licenses
        run: |
          $sdkPath = "${{ env.ANDROID_SDK_ROOT }}\cmdline-tools\16.0\bin\sdkmanager.bat"
          if (Test-Path $sdkPath) {
            "y" | & $sdkPath --licenses 2>&1 | Out-Null
          }

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}.x

      - name: Install MAUI Workload
        run: dotnet workload install maui-android --skip-sign-check

      - name: Clean Solution
        run: dotnet clean --nologo -v minimal || true

      - name: Restore Dependencies (Android)
        run: |
          dotnet restore GalaxyBudsClient.Android/GalaxyBudsClient.Android.csproj `
            -p:IsAndroid=true `
            -p:AndroidSdkDirectory=%ANDROID_SDK_ROOT% `
            -p:TargetPlatformVersion=36

      - name: Build Android APK
        run: |
          dotnet publish GalaxyBudsClient.Android/GalaxyBudsClient.Android.csproj `
            -f net10.0-android36.0 `
            -c Release `
            -p:IsAndroid=true `
            -p:AndroidSdkDirectory=%ANDROID_SDK_ROOT% `
            -p:TargetPlatformVersion=36 `
            -p:AndroidPackageFormats=apk `
            --no-restore

      - name: Upload APK Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyBudsClient-APK
          path: GalaxyBudsClient.Android/bin/Release/net10.0-android36.0/*-Signed.apk
          if-no-files-found: ignore

      - name: Upload App Bundle Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyBudsClient-AAB
          path: GalaxyBudsClient.Android/bin/Release/net10.0-android36.0/*-Signed.aab
          if-no-files-found: ignore
          
